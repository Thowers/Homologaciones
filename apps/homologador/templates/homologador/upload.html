{% extends "layouts/base.html" %}

{% block title %} Cargar y Homologar {% endblock %}

{% block content %}

<style>
    /* VARIABLES DE COLOR UMB */
    :root {
        --umb-blue: #003366; /* Azul Oscuro Institucional */
        --umb-light-gray: #f4f4f4; /* Fondo de Contenedor */
        --text-color: #333;
        --success-color: #28a745; /* Verde para √âxito */
        --error-color: #dc3545; /* Rojo para Error */
    }

    /* ESTILOS GENERALES Y FUENTES */
    body {
        font-family: Arial, sans-serif;
        background-color: white;
        color: var(--text-color);
        margin: 0;
        padding: 0;
    }

    h2 {
        color: var(--umb-blue);
        border-bottom: 2px solid var(--umb-blue);
        padding-bottom: 5px;
        margin-bottom: 20px;
    }

    /* ESTILOS DEL FORMULARIO Y BOT√ìN */
    form p {
        margin-bottom: 15px;
    }

    #submit-button {
        background-color: var(--umb-blue);
        color: white;
        border: none;
        padding: 10px 20px;
        font-size: 16px;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    #submit-button:hover:not(:disabled) {
        background-color: #004d99; /* Azul m√°s claro al pasar el rat√≥n */
    }
    
    #submit-button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
    }

    /* SPINNER Y MENSAJES DE CARGA */
    .spinner {
        border: 4px solid var(--umb-light-gray);
        border-top: 4px solid var(--umb-blue); /* Color del spinner azul */
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        display: none;
        margin-right: 10px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .submit-container {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
    }

    /* CONTENEDOR DE RESULTADOS (COLUMNAS) */
    .resultado-container {
        display: flex;
        gap: 20px;
        margin-top: 20px;
    }

    .resultado-columna {
        flex: 1;
        border: 1px solid var(--umb-blue); /* Borde azul */
        background-color: var(--umb-light-gray); /* Fondo gris claro */
        padding: 15px;
        border-radius: 8px;
    }

    .resultado-columna h4 {
        color: var(--umb-blue);
        margin-top: 0;
        border-bottom: 1px solid #ccc;
        padding-bottom: 5px;
    }

    .materia-item {
        border-bottom: 1px dashed #cccccc;
        padding: 8px 0;
        margin-bottom: 5px;
        font-size: 0.95em;
    }

    .materia-item:last-child {
        border-bottom: none;
    }

    .materia-destino-nombre {
        font-weight: bold;
        color: var(--text-color);
    }

    /* ESTADOS */
    .estado-homologada {
        color: var(--success-color);
        font-weight: bold;
    }

    .estado-no-aplica {
        color: var(--error-color);
        font-weight: bold;
    }

    /* ESTILO PARA EL CONTENIDO INCLUIDO EN BASE.HTML */
    main {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto; /* Centrar el contenido */
    }

    /* üö® ESTILO BOT√ìN DE DESCARGA üö® */
    .btn-descarga {
        display: inline-block;
        background-color: var(--umb-blue); /* Azul UMB */
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        text-decoration: none;
        font-weight: bold;
        transition: background-color 0.3s;
        margin-top: 15px;
        border: 2px solid var(--umb-blue);
    }
    .btn-descarga:hover {
        background-color: #004d99; /* Azul m√°s claro */
    }
</style>

<h2>Cargar Historial y Homologar</h2>

<form id="homologacion-form" method="post" enctype="multipart/form-data" action="{% url 'procesar_homologacion' %}">
    {% csrf_token %}
    {{ form.as_p }}
    
    <div class="submit-container">
        <button type="submit" id="submit-button">Iniciar Homologaci√≥n</button>
        <div id="loading-spinner" class="spinner"></div>
        <span id="loading-message" style="margin-left: 10px; color: #555;"></span>
    </div>
</form>

<hr>

<h3>Resultado de la Homologaci√≥n:</h3>
<p id="mensaje-estado">Esperando resultados...</p>

<div id="resultados-visuales" class="resultado-container">
    <div id="columna-homologadas" class="resultado-columna">
        <h4>‚úÖ Homologadas</h4>
    </div>
    <div id="columna-no-aplica" class="resultado-columna">
        <h4>‚ùå No Aplica</h4>
    </div>
</div>

<div id="descarga-container"></div>

<script>
    // Funci√≥n para renderizar los resultados en las columnas (sin cambios)
    function renderResults(results) {
        const homologadasCol = document.getElementById('columna-homologadas');
        const noAplicaCol = document.getElementById('columna-no-aplica');
        const mensajeEstado = document.getElementById('mensaje-estado');
        
        // Limpiar contenido anterior
        homologadasCol.innerHTML = '<h4>‚úÖ Homologadas</h4>';
        noAplicaCol.innerHTML = '<h4>‚ùå No Aplica</h4>';
        mensajeEstado.textContent = '';
        document.getElementById('descarga-container').innerHTML = ''; // Limpiar bot√≥n

        if (!results || results.length === 0) {
            mensajeEstado.textContent = 'Proceso completado, pero no se encontraron resultados de homologaci√≥n v√°lidos.';
            return;
        }

        results.forEach(materia => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'materia-item';

            const estado = materia.estado || 'N/A';
            const estadoClass = estado === 'HOMOLOGADA' ? 'estado-homologada' : 'estado-no-aplica';
            
            // Mostrar los cr√©ditos otorgados si aplica
            const detallesHomologada = estado === 'HOMOLOGADA' ? 
                `<br>Homologada con: <strong>${materia.materia_origen_homologada}</strong> (${materia.creditos_otorgados} Cr√©ditos)` : 
                '';

            itemDiv.innerHTML = `
                <span class="materia-destino-nombre">${materia.materia_destino} (${materia.codigo_destino})</span>
                ${detallesHomologada}
                <br>
                Estado: <span class="${estadoClass}">${estado}</span>
                <br>
                <small>Raz√≥n: ${materia.razon_homologacion || 'Sin justificaci√≥n.'}</small>
            `;

            if (estado === 'HOMOLOGADA') {
                homologadasCol.appendChild(itemDiv);
            } else {
                noAplicaCol.appendChild(itemDiv);
            }
        });
    }


    document.getElementById('homologacion-form').addEventListener('submit', function(event) {
        event.preventDefault();
        
        const form = event.target;
        const formData = new FormData(form);
        const submitButton = document.getElementById('submit-button');
        const spinner = document.getElementById('loading-spinner');
        const message = document.getElementById('loading-message');
        const mensajeEstado = document.getElementById('mensaje-estado');
        const descargaContainer = document.getElementById('descarga-container'); // Obtener el contenedor

        // Limpieza inicial
        document.getElementById('columna-homologadas').innerHTML = '<h4>‚úÖ Homologadas</h4>';
        document.getElementById('columna-no-aplica').innerHTML = '<h4>‚ùå No Aplica</h4>';
        descargaContainer.innerHTML = ''; // Limpiar bot√≥n de descarga anterior
        
        // --- PASO 1: Iniciar carga ---
        submitButton.disabled = true;
        spinner.style.display = 'block';
        mensajeEstado.textContent = 'Procesando... esto puede tardar unos segundos.';

        fetch(form.action, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json().then(data => ({ status: response.status, data: data })))
        .then(({ status, data }) => {
            // --- PASO 2: Finalizar carga ---
            submitButton.disabled = false;
            spinner.style.display = 'none';
            message.textContent = '';
            
            if (status === 200 && data.status === 'success') {
                // RENDERIZAR RESULTADOS VISUALES
                renderResults(data.resultado); 
                mensajeEstado.textContent = '¬°Homologaci√≥n procesada con √©xito!';
                
                // üö® PASO CLAVE: MOSTRAR BOT√ìN DE DESCARGA üö®
                if (data.historico_id) {
                    // Genera la URL usando la sintaxis de Django URL tag
                    const urlDescarga = `{% url 'descargar_docx' 0 %}`.replace('0', data.historico_id);
                    descargaContainer.innerHTML = `
                        <a href="${urlDescarga}" class="btn-descarga">
                            Descargar Informe DOCX
                        </a>
                    `;
                }

                alert("¬°Homologaci√≥n exitosa! Revisa los resultados y descarga el informe.");
            } else {
                // Manejo de Errores
                const errorMessage = data.message || `Error HTTP ${status}`;
                mensajeEstado.textContent = `Error (${status}): ${errorMessage}`;
                console.error("Error al procesar:", data);
                alert(`Error: ${errorMessage}`);
            }
        })
        .catch(error => {
            // --- PASO 3: Error de red ---
            submitButton.disabled = false;
            spinner.style.display = 'none';
            message.textContent = '';
            
            mensajeEstado.textContent = `Error de red: ${error.message || error}`;
            console.error("Error de Fetch:", error);
            alert(`Error de red: ${error.message || error}`);
        });
    });
</script>

{% endblock %}